<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
</head>

<body>

    <h1 class="text-center">Freerey Software</h1>

    <div style="display: inline-block; width: 70%; vertical-align: top;">
        <!-- File input and table 1 -->
        <p>Upload Billed File:</p>
        <input type="date" id="datePicker">
        <input type="file" id="upload" />
        <table id="excelData" style="width: 100%;"></table>
    </div>

    <div style="display: inline-block; width: 20%; vertical-align: top;">
        <!-- File input and table 2 -->
        <p>Upload Roaster File:</p>
        <input type="file" id="upload2" />
        <table id="excelData2" style="width: 100%;"></table>
    </div>

    <button id="save" class="btn btn-primary">Save Updated File</button>

    <script>
        let table1Data = [];
        let table2Data = [];

        // below updates the Paid column on the second table with the paid amount from the first talbe 
        function updatePaidAmounts() {
            table2Data.forEach(row2 => {
                let matchFound = false;
                table1Data.forEach(row1 => {
                    if (row1.Name?.toLowerCase().trim() === row2.Name?.toLowerCase().trim()
                        && row1["Date of Service"] === row2["Date of Service"]) {
                        row2.Paid = row1.Paid;
                        matchFound = true;
                    }
                });
                if (!matchFound) {
                    row2.Paid = "Not Found";
                }
            });

            // calling the Render Table function to Re-Populate the Second Table

            renderTable('excelData2', table2Data);
        }


        // below function is formating dates that comes in from Excel Seriel Format to dd/mm/yyyy format
        function excelDateToJSDate(serial) {
            if (!serial || typeof serial !== 'number') {
                // Return an empty string for empty or invalid input
                return '';
            }
            const epoch = new Date(1899, 11, 30); // Excel epoch date
            const jsDate = new Date(epoch.getTime() + (serial * 86400000));

            // Format the date to MM/DD/YYYY
            const day = jsDate.getDate().toString().padStart(2, '0');
            const month = (jsDate.getMonth() + 1).toString().padStart(2, '0');
            const year = jsDate.getFullYear();
            return `${month}/${day}/${year}`;
        }

        // Utility function to check if the value is a serial number (date)
        function isSerialDate(value) {
            return typeof value === 'number' && value > 0 && value < 60000;
        }

        // Example usage:
        const serialNumber = 45101; // Corresponds to 01/11/2024
        if (isSerialDate(serialNumber)) {
            const formattedDate = excelDateToJSDate(serialNumber);
            console.log(formattedDate); // Outputs: 01/11/2024
        }

        // Test with an empty value
        const emptyValue = null;
        const result = excelDateToJSDate(emptyValue);
        console.log(result); // Outputs: ''


        // Function to format dollar amounts
        function formatDollarAmount(value) {
            if (typeof value === 'number') {
                return `$${value.toFixed(2)}`;
            }
            return value;
        }


        function excelDateToJSDate(serial) {
    if (!serial || typeof serial !== 'number') {
        // Return an empty string for empty or invalid input
        return '';
    }
    const epoch = new Date(1899, 11, 30); // Excel epoch date
    const jsDate = new Date(epoch.getTime() + (serial * 86400000));
    
    // Format the date to MM/DD/YYYY
    const day = jsDate.getDate().toString().padStart(2, '0');
    const month = (jsDate.getMonth() + 1).toString().padStart(2, '0');
    const year = jsDate.getFullYear();
    return `${month}/${day}/${year}`;
}

// renderTable Function


function renderTable(tableId, data) {
    if (!data || data.length === 0) {
        document.getElementById(tableId).innerHTML = 'No data available.';
        return;
    }

    let tableHTML = '<thead><tr>';

    // Get the headers from the first row
    const headers = Object.keys(data[0]);

    // Render headers
    headers.forEach(header => {
        tableHTML += `<th scope="col">${header}</th>`;
    });

    tableHTML += '</tr></thead><tbody class="table table-bordered">';

    data.forEach(row => {
        tableHTML += '<tr>';
        headers.forEach(header => {
            let cellValue = row[header];

            // If the column header contains 'Date', treat it as a date
            if (header.toLowerCase().includes('date') && isSerialDate(cellValue)) {
                cellValue = excelDateToJSDate(cellValue);
            }
            // If the column header contains 'Amount' or similar, treat it as a dollar amount
            else if (header.toLowerCase().includes('amount') && typeof cellValue === 'number') {
                cellValue = formatDollarAmount(cellValue);
            }

            // Ensure empty or undefined values are displayed as empty cells
            tableHTML += `<td>${cellValue != null ? cellValue : ''}</td>`;
        });
        tableHTML += '</tr>';
    });

    tableHTML += '</tbody>';

    document.getElementById(tableId).innerHTML = tableHTML;
}

        // Upload file 1
        document.getElementById('upload').addEventListener('change', function (e) {
            const file = e.target.files[0];
            const reader = new FileReader();

            reader.onload = function (event) {
                const data = event.target.result;
                const workbook = XLSX.read(data, { type: 'binary' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];

                // Convert sheet to JSON data as raw rows
                let rawData = XLSX.utils.sheet_to_json(sheet, { header: 1 }); // Get raw data as an array of rows

                let firstRow = rawData[0];
                let secondRow = rawData[1];

                // Check if the first row only contains empty cells or commas
                const isFirstRowEmptyOrCommas = firstRow.every(cell => cell === '' || typeof cell === 'string' && cell.includes(','));

                // If the first row contains only commas or is empty, use the second row as keys
                if (isFirstRowEmptyOrCommas) {
                    // Use second row as keys
                    table1Data = rawData.slice(1).map(row => {
                        let rowData = {};
                        secondRow.forEach((key, index) => {
                            rowData[key] = row[index];
                        });
                        return rowData;
                    });
                } else {
                    // If the first row has valid keys, use it
                    table1Data = rawData.slice(1).map(row => {
                        let rowData = {};
                        firstRow.forEach((key, index) => {
                            rowData[key] = row[index];
                        });
                        return rowData;
                    });
                }

                renderTable('excelData', table1Data); // Render table 1 with the data
            };

            reader.readAsBinaryString(file);
        });


        document.getElementById('upload2').addEventListener('change', function (e) {
            const file = e.target.files[0];
            const reader = new FileReader();

            reader.onload = function (event) {
                const data = event.target.result;
                const workbook = XLSX.read(data, { type: 'binary' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                table2Data = XLSX.utils.sheet_to_json(sheet); // Store data in table2Data

                // Render table 2 (with or without 'Paid' column)
                renderTable('excelData2', table2Data);

                // After rendering, update 'paid' values where missing
                updatePaidAmounts();
            };

            reader.readAsBinaryString(file);
        });


        document.getElementById('datePicker').addEventListener('change', function (e) {
            const selectedDate = e.target.value;
            if (selectedDate) {
                table2Data.forEach(row => {
                    row["Date of Billed"] = selectedDate; // Update the "Date of Billed" for each row
                });
                renderTable('excelData2', table2Data); // Re-render table 2 with new "Date of Billed" field
            }
        });


        document.getElementById('save').addEventListener('click', function () {
            if (table2Data.length === 0) {
                alert("No data available to save.");
                return;
            }

            const worksheet = XLSX.utils.json_to_sheet(table2Data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Updated Data');
            XLSX.writeFile(workbook, 'Updated_File.xlsx');
        });


    </script>

</body>

</html>